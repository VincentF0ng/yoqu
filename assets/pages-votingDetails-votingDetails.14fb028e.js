import{o as e,a as t,w as a,h as o,f as s,t as i,b as l,g as n,v as d,m as c,l as r,E as u,L as p,G as f,k as v,a6 as h,p as m,d as _,u as y,B as g,C as D,F as k,x as b,r as C,i as w,P as x,af as I,ad as L,n as F,ae as T,ac as J,y as B,ab as V}from"./index-ab7ec73d.js";import{_ as z}from"./uni-title.3f4c5e47.js";import{r as Q}from"./uni-app.es.f46513ae.js";import{_ as $}from"./uni-icons.63e5f710.js";import{_ as j}from"./_plugin-vue_export-helper.1b428a4d.js";import{g as S}from"./profile.cb2024f0.js";const G=j({name:"uni-tooltip",data:()=>({}),props:{content:{type:String,default:""},placement:{type:String,default:"bottom"}}},[["render",function(d,c,r,u,p,f){const v=n;return e(),t(v,{class:"uni-tooltip"},{default:a((()=>[o(d.$slots,"default",{},void 0,!0),r.content||d.$slots.content?(e(),t(v,{key:0,class:"uni-tooltip-popup"},{default:a((()=>[o(d.$slots,"content",{},(()=>[s(i(r.content),1)]),!0)])),_:3})):l("",!0)])),_:3})}],["__scopeId","data-v-f9ee3e38"]]);const M=j({data:()=>({userInfo:{},initiation:0,participation:0,id:"",voteDetail:null,radio:null,checkbox:[],options:[],voted:!1,myVote:{},voteCastList:[]}),methods:{handleProfile(){d(),c({url:"/pages/votingTool/votingTool"})},handleCloseVote(){d(),this.userInfo.openid===this.voteDetail.creator.openid&&r({title:"提示",content:"关闭投票后将不可再进行投票（结果仍可查看），是否继续？",success:async e=>{e.confirm&&this.updateDB("votes",this.voteDetail._id,{status:2},this.getData)}})},handleDeleteVote(){d(),this.userInfo.openid===this.voteDetail.creator.openid&&r({title:"提示",content:"删除投票将彻底清除记录，是否继续？",success:async e=>{e.confirm&&this.updateDB("votes",this.voteDetail._id,{status:3},(()=>{this.$nextTick((e=>{c({url:"/pages/votingTool/votingTool"})}))}))}})},handleUnanonymize(){d(),this.voted&&this.myVote.anonymous&&r({title:"提示",content:"撤销匿名后不能再操作匿名，是否继续？",success:e=>{e.confirm&&this.updateDB("vote_cast",this.myVote._id,{anonymous:!1},this.getData)}})},async updateDB(e,t,a,o){u({title:"加载中...",mask:!0});const s=p.databaseForJQL(),i=await s.collection(e).where(`_id == "${t}"`).update(a);f(),i&&0===i.errCode&&i.updated>0?v({icon:"success",title:"操作成功！"}):v({icon:"error",title:"操作失败！"}),o&&o()},async handleVote(e){if(d(),!this.userInfo._id){return(await r({title:"提示",content:"请先设置昵称和头像（仅用于投票后结果展示）。",showCancel:!1})).confirm?c({url:"/pages/profile/profile"}):void 0}const{type:t,time_limit:a,deadline:o,people_limit:s,max_people:i,status:l,create_date:n,vote_cast:h}=this.voteDetail;if(1===t&&!this.radio||2===t&&this.checkbox.length<1)return v({icon:"error",title:"请先选择！"});if(2===l)return v({icon:"error",title:"该投票已关闭！"});if(1===a&&Date.now()>new Date(o))return v({icon:"error",title:"该投票已截止！"});if(1===s&&h.length===i)return v({icon:"error",title:"人数已达上限！"});const m={vote_id:this.id,user_openid:this.userInfo.openid,anonymous:e,selected_options:1===t?[this.radio]:this.checkbox};u({title:"加载中...",mask:!0});const _=p.databaseForJQL(),y=await _.collection("vote_cast").add(m);f(),y&&0===y.errCode?v({icon:"success",title:"投票成功！"}):v({icon:"error",title:"操作失败！"}),this.getData()},async getData(){u({title:"加载中...",mask:!0});const e=p.databaseForJQL(),t=e.collection("votes,users").where(`_id == "${this.id}" && status < 3`).getTemp(),a=e.collection("vote_cast,users").where(`vote_id == "${this.id}"`).getTemp(),o=await e.multiSend(t,a);if(f(),0===o.errCode){const[e,t]=o.dataList;this.fixDBData(e,t)}else v({icon:"error",title:"服务器开小差！"})},fixDBData(e,t){if(e.errCode||t.errCode)return v({icon:"error",title:"服务器开小差！"});if(0===e.data.length)return r({title:"提示",content:"该投票已被删除，查看我参与的投票？",showCancel:!1,success:e=>{e.confirm&&h({url:"/pages/votingTool/votingTool?type=1"})}});const a=e.data[0],o=t.data.map((e=>{const t=e.user_openid?e.user_openid[0]:{},o={...e,user_info:t};return delete o.user_openid,t&&t.openid===this.userInfo.openid&&(this.voted=!0,this.myVote=e,e.selected_options.length&&(1===a.type?this.radio=e.selected_options[0]:this.checkbox=e.selected_options)),o}));this.voteDetail={...a,creator:a.creator?a.creator[0]:{},vote_cast:o};const s=new Array(a.options.length);for(let i=0;i<a.options.length;i++){const e=a.options[i];s[i]=[];for(let t=0;t<o.length;t++){const a=o[t];if(a.selected_options.includes(e)){const e="https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0",t="匿名";s[i].push({_id:a._id,anonymous:a.anonymous,avatar:a.anonymous?e:a.user_info.avatar,nickname:a.anonymous?t:a.user_info.nickname,time:new Date(a.create_date).toLocaleString()})}}}this.voteCastList=s},async init(){let e=m("user");e?this.userInfo=e:(e=await S(),this.userInfo=e||this.userInfo)}},onLoad(e){if(!e.id)return h({url:"/pages/votingTool/votingTool"});this.id=e.id,this.init(),this.getData()},onShareAppMessage(){return{title:`${this.userInfo.nickname} 邀请您来投票：${this.voteDetail.title}`,path:"/pages/votingDetails/votingDetails?id="+this.id,imageUrl:"https://mp-9c9554a3-d4de-4f0f-b941-dfe1990da1c1.cdn.bspapp.com/cloudstorage/d4e9b485-8118-4928-bf2b-518a31be2f31.png"}},onShareTimeline(){return{title:`${this.userInfo.nickname} 邀请您来投票：${this.voteDetail.title}`,path:"/pages/votingDetails/votingDetails?id="+this.id,imageUrl:"https://mp-9c9554a3-d4de-4f0f-b941-dfe1990da1c1.cdn.bspapp.com/cloudstorage/d4e9b485-8118-4928-bf2b-518a31be2f31.png"}}},[["render",function(o,d,c,r,u,p){const f=Q(C("uni-title"),z),v=Q(C("uni-icons"),$),h=w,m=n,j=x,S=T,M=J,P=B,q=Q(C("uni-tooltip"),G),A=I,N=V,R=L;return e(),t(m,{class:"voting-details"},{default:a((()=>[_(m,{class:"header"},{default:a((()=>[u.voteDetail?(e(),y(k,{key:0},[_(f,{title:u.voteDetail.title,align:"center",type:"h1"},null,8,["title"]),_(m,{class:"vote-info"},{default:a((()=>[_(m,{class:"info"},{default:a((()=>[_(m,{class:"info-item"},{default:a((()=>[_(v,{type:"staff-filled",size:"18"}),_(m,{class:"info-item-msg"},{default:a((()=>[s(i(u.voteDetail.vote_cast.length)+" ",1),g(_(h,null,{default:a((()=>[s("/ "+i(u.voteDetail.max_people),1)])),_:1},512),[[D,1===u.voteDetail.people_limit]]),s("人已投票")])),_:1})])),_:1}),_(m,{class:"info-item"},{default:a((()=>[_(v,{type:"calendar",size:"18"}),2===u.voteDetail.status?(e(),t(m,{key:0,class:"info-item-msg"},{default:a((()=>[s("已关闭")])),_:1})):0===u.voteDetail.time_limit?(e(),t(m,{key:1,class:"info-item-msg"},{default:a((()=>[s("不限时")])),_:1})):u.voteDetail.deadline?(e(),t(m,{key:2,class:"info-item-msg"},{default:a((()=>[s(i(new Date(u.voteDetail.deadline).toLocaleString())+" 截止",1)])),_:1})):l("",!0)])),_:1})])),_:1}),_(m,{class:"creator"},{default:a((()=>[_(h,{class:"nickname"},{default:a((()=>[s("@"+i(u.voteDetail.creator.nickname),1)])),_:1}),_(h,null,{default:a((()=>[s(i(new Date(u.voteDetail.create_date).toLocaleDateString()),1)])),_:1})])),_:1})])),_:1})],64)):l("",!0)])),_:1}),_(m,{class:"main"},{default:a((()=>[u.voteDetail?(e(),y(k,{key:0},[_(j,{class:"share-btn",size:"mini","open-type":"share"},{default:a((()=>[_(v,{type:"chatboxes-filled",size:"16"}),s(" 转发")])),_:1}),_(m,{class:"description"},{default:a((()=>[s(i(u.voteDetail.description),1)])),_:1})],64)):l("",!0),u.voteDetail&&1===u.voteDetail.type?(e(),t(A,{key:1,onChange:d[0]||(d[0]=e=>u.radio=e.detail.value),class:"options"},{default:a((()=>[(e(!0),y(k,null,b(this.voteDetail.options,((o,n)=>(e(),t(m,{class:"options-item-wrap",key:o+n},{default:a((()=>[_(M,{class:F(["options-item",{"seleted-item":o===u.radio}])},{default:a((()=>[_(S,{disabled:u.voted,value:o,checked:o===u.radio},null,8,["disabled","value","checked"]),_(m,null,{default:a((()=>[s(i(o),1)])),_:2},1024)])),_:2},1032,["class"]),u.voted&&(u.userInfo.openid===u.voteDetail.creator.openid||u.voteDetail.result_type<3)?(e(),t(m,{key:0,class:"vote-res"},{default:a((()=>[_(h,{class:"vote-res-count"},{default:a((()=>[s(i(u.voteCastList[n].length)+" 人选择",1)])),_:2},1024),_(m,{class:"vote-res-percent"},{default:a((()=>[s(i(Math.floor(u.voteCastList[n].length/u.voteDetail.vote_cast.length*1e4)/100+"%"),1)])),_:2},1024)])),_:2},1024)):l("",!0),!u.voted||u.userInfo.openid!==u.voteDetail.creator.openid&&1!==u.voteDetail.result_type?l("",!0):(e(),t(m,{key:1,class:"vote-user"},{default:a((()=>[(e(!0),y(k,null,b(u.voteCastList[n],((o,s)=>(e(),t(q,{class:"avatar-tooltip",content:o.nickname+" "+o.time,key:o._id},{default:a((()=>[_(P,{class:"avatar",src:o.avatar,mode:"aspectFit"},null,8,["src"])])),_:2},1032,["content"])))),128))])),_:2},1024))])),_:2},1024)))),128))])),_:1})):l("",!0),u.voteDetail&&2===u.voteDetail.type?(e(),t(R,{key:2,onChange:d[1]||(d[1]=e=>u.checkbox=e.detail.value),class:"options"},{default:a((()=>[(e(!0),y(k,null,b(this.voteDetail.options,((o,n)=>(e(),t(m,{class:"options-item-wrap",key:o+n},{default:a((()=>[_(M,{class:F(["options-item",{"seleted-item":u.checkbox.includes(o)}])},{default:a((()=>[_(N,{disabled:u.voted,value:o,checked:u.checkbox.includes(o)},null,8,["disabled","value","checked"]),_(m,null,{default:a((()=>[s(i(o),1)])),_:2},1024)])),_:2},1032,["class"]),u.voted&&(u.userInfo.openid===u.voteDetail.creator.openid||u.voteDetail.result_type<3)?(e(),t(m,{key:0,class:"vote-res"},{default:a((()=>[_(h,{class:"vote-res-count"},{default:a((()=>[s(i(u.voteCastList[n].length)+" 人选择",1)])),_:2},1024),_(m,{class:"vote-res-percent"},{default:a((()=>[s(i(Math.floor(u.voteCastList[n].length/u.voteDetail.vote_cast.length*1e4)/100+"%"),1)])),_:2},1024)])),_:2},1024)):l("",!0),!u.voted||u.userInfo.openid!==u.voteDetail.creator.openid&&1!==u.voteDetail.result_type?l("",!0):(e(),t(m,{key:1,class:"vote-user"},{default:a((()=>[(e(!0),y(k,null,b(u.voteCastList[n],((o,s)=>(e(),t(q,{class:"avatar-tooltip",content:o.anonymous?"匿名":o.nickname,key:o._id},{default:a((()=>[o.anonymous?(e(),t(P,{key:0,class:"avatar",src:"https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0",mode:"aspectFit"})):(e(),t(P,{key:1,class:"avatar",src:o.avatar,mode:"aspectFit"},null,8,["src"]))])),_:2},1032,["content"])))),128))])),_:2},1024))])),_:2},1024)))),128))])),_:1})):l("",!0),_(m,{class:"vote-msg"},{default:a((()=>[g(_(m,null,{default:a((()=>[s("投票已关闭")])),_:1},512),[[D,u.voted&&2===u.voteDetail.status]]),g(_(m,null,{default:a((()=>[s("投票结果设置仅发起人可见")])),_:1},512),[[D,u.voted&&3===u.voteDetail.result_type]])])),_:1})])),_:1}),_(m,{class:"footer"},{default:a((()=>[g(_(j,{class:"btn btn-200",type:"default",onClick:d[2]||(d[2]=e=>p.handleVote(!0))},{default:a((()=>[s("匿名投票")])),_:1},512),[[D,!u.voted]]),g(_(j,{class:"btn btn-flex",type:"primary",onClick:d[3]||(d[3]=e=>p.handleVote(!1))},{default:a((()=>[s("投票")])),_:1},512),[[D,!u.voted]]),g(_(j,{class:"btn btn-200",type:"warn",onClick:p.handleDeleteVote},{default:a((()=>[s("删除投票")])),_:1},8,["onClick"]),[[D,u.voted&&u.userInfo.openid===u.voteDetail.creator.openid&&2===u.voteDetail.status]]),g(_(j,{class:"btn btn-200",type:"warn",onClick:p.handleCloseVote},{default:a((()=>[s("关闭投票")])),_:1},8,["onClick"]),[[D,u.voted&&u.userInfo.openid===u.voteDetail.creator.openid&&1===u.voteDetail.status]]),g(_(j,{class:"btn btn-200",type:"default",onClick:p.handleUnanonymize},{default:a((()=>[s("撤销匿名")])),_:1},8,["onClick"]),[[D,u.voted&&u.myVote.anonymous]]),g(_(j,{class:"btn btn-flex",type:"primary",disabled:""},{default:a((()=>[s("已投票")])),_:1},512),[[D,u.voted]]),_(v,{class:"profile-icon",type:"person-filled",size:"40",onClick:p.handleProfile},null,8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-cd9f32f3"]]);export{M as default};
