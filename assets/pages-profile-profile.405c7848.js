import{ah as a,k as e,E as t,L as s,G as i,s as n,p as l,o,a as r,w as c,g as u,d,f,y as m,P as p,I as h}from"./index-ab7ec73d.js";import{g as k}from"./profile.cb2024f0.js";import{_ as v}from"./_plugin-vue_export-helper.1b428a4d.js";const _=v({data:()=>({nickname:"用户名",avatar:"https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0",userInfo:{}}),methods:{goBack(){a()},chooseAvatar(a){this.avatar=a.detail.avatarUrl},nicknameChange(a){this.nickname=a.target.value},async updateProfile(){let l=this.avatar,o=this.nickname,r=this.userInfo.avatar,c=this.userInfo.nickname,u=this.userInfo.openid;if(l===r&&o===c)return e({icon:"success",title:"更新成功！",complete:()=>{a()}});if(t({title:"更新中"}),-1!==l.indexOf("tmp")){const a=await s.uploadFile({filePath:l,cloudPath:`user_${u}.${l.slice(l.lastIndexOf("."))}`});a.success&&(l=a.fileID)}const d=s.database();let f=null;if(f=this.userInfo._id?await d.collection("users").where({openid:u}).update({avatar:l,nickname:o}):await d.collection("users").add({openid:u,avatar:l,nickname:o}),i(),f&&0===f.result.errCode){if(e({icon:"success",title:"更新成功！",success:()=>{n("user",{_id:f.result.id,...this.userInfo,avatar:l,nickname:o}),a()}}),r&&r!==l&&r.includes("cloudstorage")){s.importObject("profile").deleteFile([r])}}else e({icon:"error",title:"更新失败！"})},async init(){t({title:"加载中"});let a=l("user");a?(this.userInfo=a,this.avatar=a.avatar,this.nickname=a.nickname):(a=await k(),this.userInfo=a||{},this.avatar=a.avatar,this.nickname=a.nickname),i()}},onShow(){this.init()}},[["render",function(a,e,t,s,i,n){const l=u,k=m,v=p,_=h;return o(),r(l,{class:"profile"},{default:c((()=>[d(l,{class:"form"},{default:c((()=>[d(l,{class:"form-item"},{default:c((()=>[d(l,{class:"label"},{default:c((()=>[f("头像")])),_:1}),d(l,{class:"input"},{default:c((()=>[d(v,{class:"avatar-btn",type:"default","open-type":"chooseAvatar",onChooseavatar:n.chooseAvatar},{default:c((()=>[d(k,{class:"avatar",src:i.avatar},null,8,["src"])])),_:1},8,["onChooseavatar"])])),_:1})])),_:1}),d(l,{class:"form-item"},{default:c((()=>[d(l,{class:"label"},{default:c((()=>[f("昵称")])),_:1}),d(l,{class:"input"},{default:c((()=>[d(_,{type:"nickname",placeholder:"请输入昵称",modelValue:i.nickname,"onUpdate:modelValue":e[0]||(e[0]=a=>i.nickname=a),onBlur:n.nicknameChange},null,8,["modelValue","onBlur"])])),_:1})])),_:1})])),_:1}),d(l,{class:"option-wrap"},{default:c((()=>[d(v,{type:"primary",class:"option-btn primary",onClick:n.updateProfile},{default:c((()=>[f("确认")])),_:1},8,["onClick"]),d(v,{type:"default",class:"option-btn default",onClick:n.goBack},{default:c((()=>[f("返回")])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-64516c50"]]);export{_ as default};
