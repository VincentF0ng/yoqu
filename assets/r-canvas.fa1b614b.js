import{K as t,ab as i,j as e,a3 as a,ac as s,ad as l,o as h,a as r,w as o,d as c,n,e as d,b as p,a4 as x,g as w}from"./index-aa4be687.js";import{_ as m}from"./uni-app.es.2235e1df.js";const _=m({mixins:[{data:()=>({system_info:{},canvas_width:0,canvas_height:0,ctx:null,canvas_id:null,hidden:!1,scale:1,r_canvas_scale:1,if_ctx:!0}),methods:{fillRoundRect(t){return new Promise(((i,e)=>{let a=this.compatibilitySize(parseFloat(t.x)*this.scale),s=this.compatibilitySize(parseFloat(t.y)*this.scale),l=this.compatibilitySize(parseFloat(t.w)*this.scale),h=this.compatibilitySize(parseFloat(t.h)*this.scale),r=t.radius?parseFloat(t.radius)*this.scale:10*this.scale,o=t.fill_color||"black";if(2*r>l||2*r>h)return e("The diameter of the circle must be less than the width and height of the rectangle"),!1;this.ctx.save(),this.ctx.translate(a,s),this.drawRoundRectPath({w:l,h:h,radius:r}),this.ctx.fillStyle=o,this.ctx.fill(),this.ctx.restore(),i()}))},drawRoundRectPath(t){this.ctx.beginPath(0),this.ctx.arc(t.w-t.radius,t.h-t.radius,t.radius,0,Math.PI/2),this.ctx.lineTo(t.radius,t.h),this.ctx.arc(t.radius,t.h-t.radius,t.radius,Math.PI/2,Math.PI),this.ctx.lineTo(0,t.radius),this.ctx.arc(t.radius,t.radius,t.radius,Math.PI,3*Math.PI/2),this.ctx.lineTo(t.w-t.radius,0),this.ctx.arc(t.w-t.radius,t.radius,t.radius,3*Math.PI/2,2*Math.PI),this.ctx.lineTo(t.w,t.h-t.radius),this.ctx.closePath()},drawSpecialText(t){let i=t.general,e=t.list;return new Promise((async(t,a)=>{if(i)if(e&&e.length>0){for(let t in e){if(0!=t){let a=e[t-1].font_size?parseFloat(e[t-1].font_size):20;this.ctx.setFontSize(a),i.x=parseFloat(i.x)+this.ctx.measureText(e[t-1].text).width}e[t].x=i.x,e[t].y=i.y+(e[t].margin_top?parseFloat(e[t].margin_top):0),await this.drawText(e[t])}t()}else a("The length of config arr is less than 0");else a("general cannot be empty:101")}))},arrDeleteEmpty(t){let i=[];for(let e in t)t[e]&&i.push(t[e]);return i},drawText(t,i={}){return i.line_num=i.line_num?i.line_num:0,i.text_width=i.text_width?i.text_width:0,new Promise((async(e,a)=>{if(t.text){let s=0,l=0,h=t.x,r=t.y,o=t.font_size?parseFloat(t.font_size)*this.scale:20*this.scale,c=t.font_color||"#000",n=t.font_family||"Arial",d=t.line_height||t.font_size||20,p=t.text_align||"left",x=t.font_weight||"normal",w=t.font_variant||"normal",m=t.font_style||"normal",_=t.line_clamp_hint||"...",b="",y=t.max_width?parseFloat(t.max_width)*this.scale:0;if(t.is_line_break){let i=t.text.split(/[\n]/g);if(!(i&&i.length>0))return void a("Text cannot be empty:102");{let e=this.arrDeleteEmpty(i);if(!(e&&e.length>0))return void a("Text cannot be empty:103");b=e.slice(1).join("\n"),t.text=e[0]}}if(this.ctx.setFillStyle(c),this.ctx.textAlign=p,this.ctx.font=`${m} ${w} ${x} ${parseInt(o)}px ${n}`,s=i.text_width>=this.ctx.measureText(t.text).width?i.text_width:y>0?y<this.ctx.measureText(t.text).width?this.resetCompatibilitySize(y):this.resetCompatibilitySize(this.ctx.measureText(t.text).width):this.ctx.measureText(t.text).width,i.text_width=s/this.scale,y&&this.compatibilitySize(this.ctx.measureText(t.text).width)>this.compatibilitySize(y)){let e="",a=t.text.split("");for(let s in a){if(this.compatibilitySize(this.ctx.measureText(e+a[s]).width)>this.compatibilitySize(y)){if(t.line_clamp&&1==parseInt(t.line_clamp)){let a=e.split(""),s="";for(;;)if(a=a.slice(1),s=a.join(""),this.compatibilitySize(this.ctx.measureText(s).width)<=this.compatibilitySize(this.ctx.measureText(_).width)){e=e.replace(s,"");break}i.line_num+=1,this.ctx.setFontSize(parseInt(this.compatibilitySize(o))),this.ctx.fillText(e+_,this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale))}else i.line_num+=1,this.ctx.setFontSize(parseInt(this.compatibilitySize(o))),this.ctx.fillText(e,this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale)),t.text=a.slice(s).join(""),t.y=t.y+d,t.line_clamp&&(t.line_clamp=parseInt(t.line_clamp)-1),await this.drawText(t,i);break}e+=a[s]}}else{if(t.line_through_height){let i,e=parseFloat(t.x)*this.scale,a=parseFloat(t.y)*this.scale-o/2.6;"left"==p?i=this.ctx.measureText(t.text).width/1.1+parseFloat(t.x)*this.scale:"right"==p?i=parseFloat(t.x)*this.scale-this.ctx.measureText(t.text).width/1.1:"center"==p&&(e=parseFloat(t.x)*this.scale-this.ctx.measureText(t.text).width/1.1/2,i=parseFloat(t.x)*this.scale+this.ctx.measureText(t.text).width/1.1/2),this.drawLineTo({x:e,y:a,w:i,h:a,line_width:t.line_through_height,line_color:t.line_through_color,line_cap:t.line_through_cap})}i.line_num+=1,this.ctx.setFontSize(parseInt(this.compatibilitySize(o))),this.ctx.fillText(t.text,this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale)),t.line_clamp&&(t.line_clamp=parseInt(t.line_clamp)-1)}b&&await this.drawText({...t,text:b,y:t.y+d},i),l=t.font_size*i.line_num,s=i.text_width,e({draw_width:s,draw_height:l,draw_x:h,draw_y:r})}else a("Text cannot be empty:101")}))},drawLineTo(t){let i=this.compatibilitySize(t.x),e=this.compatibilitySize(t.y),a=this.compatibilitySize(t.w),s=this.compatibilitySize(t.h),l=t.line_width?parseFloat(t.line_width)*this.scale:1*this.scale,h=t.line_color||"black",r=t.line_cap||"butt";this.ctx.beginPath(),this.ctx.lineCap=r,this.ctx.lineWidth=l,this.ctx.strokeStyle=h,this.ctx.moveTo(i,e),this.ctx.lineTo(a,s),this.ctx.stroke()},compatibilitySize(t){let i=parseFloat(t)/750*this.system_info.windowWidth;return i=parseFloat(2*i),i},resetCompatibilitySize(t){return parseFloat(t/2)/this.system_info.windowWidth*750},init(e){return new Promise((async(a,s)=>{if(!e.canvas_id)return void s("Canvas ID cannot be empty, please refer to the usage example");this.hidden=e.hidden,this.canvas_id=e.canvas_id;let l=await t();this.system_info=l,this.scale=e.scale&&parseFloat(e.scale)>0?parseInt(e.scale):1,this.canvas_width=(e.canvas_width?this.compatibilitySize(e.canvas_width):l.windowWidth)*this.scale,this.canvas_height=(e.canvas_height?this.compatibilitySize(e.canvas_height):l.windowHeight)*this.scale,this.r_canvas_scale=1/this.scale,this.ctx=i(this.canvas_id,this),this.setCanvasConfig({global_alpha:e.global_alpha?parseFloat(e.global_alpha):1,backgroundColor:e.background_color?e.background_color:"#fff"}),a()}))},clearCanvas(){return new Promise((async(t,i)=>{this.ctx?(this.ctx.clearRect(0,0,parseFloat(this.canvas_width)*this.scale,parseFloat(this.canvas_height)*this.scale),await this.draw(),t()):i("canvas is not initialized:101")}))},setCanvasConfig(t){this.ctx.globalAlpha=t.global_alpha,this.ctx.fillStyle=t.backgroundColor,this.ctx.fillRect(0,0,parseFloat(this.canvas_width)*this.scale,parseFloat(this.canvas_height)*this.scale)},setCanvasWidth(t){t||e({title:"setCanvasWidth：width error",icon:"none"}),this.canvas_width=this.compatibilitySize(parseFloat(t))*this.scale,this.ctx.width=this.canvas_width},setCanvasHeight(t){t||e({title:"setCanvasWidth：height error",icon:"none"}),this.canvas_height=this.compatibilitySize(parseFloat(t))*this.scale,this.ctx.height=this.canvas_height},draw(t){return new Promise(((i,e)=>{let s=setTimeout((()=>{this.ctx.draw(!1,setTimeout((()=>{a({canvasId:this.canvas_id,quality:1,success:e=>{i(e),t&&t(e)},fail:t=>{e(JSON.stringify(t)||"Failed to generate poster:101")}},this)}),300)),clearTimeout(s)}),300)}))},drawRect(t){return new Promise((async(i,e)=>{if(!t.border_width||t.border_width<=0?t.border_width=0:t.border_width=parseFloat(t.border_width),parseFloat(t.border_width)>0){let i=JSON.parse(JSON.stringify(t));i.border_width=0,i.w=t.w+t.border_width,i.h=t.h+t.border_width,i.color=t.border_color||"black",i.border_radius&&(i.border_radius=parseFloat(i.border_radius)+parseFloat(t.border_width)/2),await this.drawRect(i)}let a=t.color||"white";t.x=parseFloat(t.x)+t.border_width/2,t.y=parseFloat(t.y)+t.border_width/2,t.color=a,this.ctx.fillStyle=a,t.is_radius||t.border_radius?(this.setNativeBorderRadius(t),this.ctx.fill()):(console.log("config.border_width",t.border_width),this.ctx.fillRect(this.compatibilitySize(t.x*this.scale),this.compatibilitySize(t.y*this.scale),this.compatibilitySize(parseFloat(t.w)*this.scale),this.compatibilitySize(parseFloat(t.h)*this.scale))),i()}))},drawImage(t){return new Promise((async(i,e)=>{if(t.url){let l,h=0;if(h=/^https?/gi.test(t.url)?1:-1!=t.url.indexOf("data:image/png;base64")||-1!=t.url.indexOf("data:image/jpeg;base64")||-1!=t.url.indexOf("data:image/gif;base64")?3:2,1==h)await this.downLoadNetworkFile(t.url).then((t=>{l=t})).catch((t=>{e(t)}));else if(2==h){const i=await s({src:t.url});try{if(i.length<=1)return void e(i[0].errMsg+":404")}catch(a){return void e(a+":500")}let h=await this.urlToBase64({url:i.path});l=h}else{if(3!=h)return void e("Other Type Errors:101");l=t.url}if(t.border_width){let i=0;if(t.border_radius){let e=t.w/t.border_radius;i=(parseFloat(t.w)+parseFloat(t.border_width))/e}await this.drawRect({x:parseFloat(t.x)-parseFloat(t.border_width)/2,y:parseFloat(t.y)-parseFloat(t.border_width)/2,w:parseFloat(t.w)+parseFloat(t.border_width),h:parseFloat(t.h)+parseFloat(t.border_width),color:t.border_color,border_radius:i,border_width:t.border_width,is_radius:t.is_radius})}t.border_radius?(t.color=t.color?t.color:"rgba(0,0,0,0)",t.w=t.w+.3,t.h=t.h+.3,this.setNativeBorderRadius(t)):t.is_radius&&(this.ctx.setStrokeStyle("rgba(0,0,0,0)"),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.compatibilitySize(parseFloat(t.x)*this.scale+parseFloat(t.w)*this.scale/2),this.compatibilitySize(parseFloat(t.y)*this.scale+parseFloat(t.h)*this.scale/2),this.compatibilitySize(parseFloat(t.w)*this.scale/2),0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip()),await this.ctx.drawImage(l,this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale),this.compatibilitySize(parseFloat(t.w)*this.scale),this.compatibilitySize(parseFloat(t.h)*this.scale)),this.ctx.restore(),i()}else{e("Links cannot be empty:101")}}))},base64ToNative:t=>new Promise(((i,e)=>{let a=(new Date).getTime();var s=`${wx.env.USER_DATA_PATH}/${a}_rCanvas.png`;wx.getFileSystemManager().writeFile({filePath:s,data:t.url.replace(/^data:\S+\/\S+;base64,/,""),encoding:"base64",success:function(){i(s)},fail:function(t){e(t)}})})),urlToBase64(t){return new Promise((async(i,e)=>{"undefined"!=typeof window?await this.downLoadNetworkFile(t.url).then((t=>{i(t)})).catch((t=>{e(t)})):"undefined"!=typeof plus?plus.io.resolveLocalFileSystemURL(t.url,(t=>{t.file((t=>{let a=new plus.io.FileReader;a.onload=t=>{i(t.target.result)},a.onerror=t=>{e(t)},a.readAsDataURL(t)}),(t=>{e(t)}))}),(t=>{e(t)})):"undefined"!=typeof wx&&wx.getFileSystemManager().readFile({filePath:t.url,encoding:"base64",success:function(t){i("data:image/png;base64,"+t.data)},fail:function(t){e(t)}})}))},setNativeBorderRadius(t){let i=t.border_radius?parseFloat(t.border_radius)*this.scale:20*this.scale;parseFloat(t.w)*this.scale<2*i&&(i=parseFloat(t.w)*this.scale/2),parseFloat(t.h)*this.scale<2*i&&(i=parseFloat(t.h)*this.scale/2),this.ctx.beginPath(),this.ctx.moveTo(this.compatibilitySize(parseFloat(t.x)*this.scale+i),this.compatibilitySize(parseFloat(t.y)*this.scale)),this.ctx.arcTo(this.compatibilitySize(parseFloat(t.x)*this.scale+parseFloat(t.w)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale),this.compatibilitySize(parseFloat(t.x)*this.scale+parseFloat(t.w)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale+parseFloat(t.h)*this.scale),this.compatibilitySize(i)),this.ctx.arcTo(this.compatibilitySize(parseFloat(t.x)*this.scale+parseFloat(t.w)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale+parseFloat(t.h)*this.scale),this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale+parseFloat(t.h)*this.scale),this.compatibilitySize(i)),this.ctx.arcTo(this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale+parseFloat(t.h)*this.scale),this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale),this.compatibilitySize(i)),this.ctx.arcTo(this.compatibilitySize(parseFloat(t.x)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale),this.compatibilitySize(parseFloat(t.x)*this.scale+parseFloat(t.w)*this.scale),this.compatibilitySize(parseFloat(t.y)*this.scale),this.compatibilitySize(i)),this.ctx.closePath(),this.ctx.strokeStyle=t.color||t.border_color||"rgba(0,0,0,0)",this.ctx.stroke(),this.ctx.save(),this.ctx.clip()},downLoadNetworkFile:t=>new Promise(((i,e)=>{l({url:t,success:t=>{200==t.statusCode?i(t.tempFilePath):e("Download Image Fail:102")},fail:t=>{e("Download Image Fail:101")}})})),saveImage:t=>new Promise(((i,e)=>{if(t){var a=document.createElement("a");a.download=t,a.href=t,document.body.appendChild(a),a.click(),a.remove(),i()}else e("FilePath cannot be null:101")}))}}]},[["render",function(t,i,e,a,s,l){const m=x,_=w;return h(),r(_,null,{default:o((()=>[c(_,{class:n(["r-canvas-component",{hidden:t.hidden}]),style:d({width:t.canvas_width/t.scale+"px",height:t.canvas_height/t.scale+"px"})},{default:o((()=>[t.canvas_id?(h(),r(m,{key:0,class:"r-canvas","canvas-id":t.canvas_id,id:t.canvas_id,style:d({width:t.canvas_width+"px",height:t.canvas_height+"px",transform:`scale(${t.r_canvas_scale})`})},null,8,["canvas-id","id","style"])):p("",!0)])),_:1},8,["style","class"])])),_:1})}],["__scopeId","data-v-05e0150b"]]);export{_};
